---
import { christmasConfig } from '@constants/site-config';
import { Icon } from 'astro-icon/components';
---

<div id="floating-nav" class="text-primary fixed right-4 bottom-4 z-50 flex flex-col gap-2" data-expanded="true">
  <div id="nav-content" class="flex scale-y-100 flex-col gap-2 opacity-100">
    {
      christmasConfig.enabled && (
        <button
          id="toggle-christmas"
          class="bg-background/80 hover:bg-background rounded-full p-2 shadow-lg backdrop-blur-sm transition-colors duration-200"
          aria-label="切换圣诞特效"
          title="切换圣诞特效"
          data-tooltip-interactive="false"
          data-tooltip-placement="left"
        >
          <Icon name="ri:snowy-fill" class="christmas-on-icon h-5 w-5" />
          <Icon name="ri:snowy-line" class="christmas-off-icon h-5 w-5" />
        </button>
      )
    }
    <button
      id="scroll-to-top"
      class="bg-background/80 hover:bg-background rounded-full p-2 shadow-lg backdrop-blur-sm transition-colors duration-200"
      aria-label="回到顶部"
      title="回到顶部"
      data-tooltip-interactive="false"
      data-tooltip-placement="left"
    >
      <Icon name="ri:arrow-up-s-line" class="h-5 w-5" />
    </button>
    <button
      id="scroll-to-bottom"
      class="bg-background/80 hover:bg-background rounded-full p-2 shadow-lg backdrop-blur-sm transition-colors duration-200"
      aria-label="滚到底部"
      title="滚到底部"
      data-tooltip-interactive="false"
      data-tooltip-placement="left"
    >
      <Icon name="ri:arrow-down-s-line" class="h-5 w-5" />
    </button>
  </div>

  <button
    id="toggle-nav"
    class="flex-center bg-background/80 hover:bg-background size-9 rounded-full shadow-lg backdrop-blur-sm transition-colors duration-200"
    aria-label="展开/收起工具栏"
    title="展开/收起工具栏"
    data-tooltip-interactive="false"
    data-tooltip-placement="left"
  >
    <Icon name="ri:magic-fill" class="menu-nav-icon hidden size-4 transition-transform duration-300" />
    <Icon name="ri:close-large-fill" class="close-nav-icon size-4 transition-transform duration-300" />
  </button>
</div>

<script>
  import { christmasEnabled, disableChristmasCompletely, enableChristmas, initChristmasState } from '@store/christmas';
  // 图标显示由 CSS 根据 html.christmas 类控制，无需 JS 订阅
  import { drawerOpen } from '@store/ui';

  function initFloatingNav() {
    const scrollToTopEle = document.getElementById('scroll-to-top');
    const scrollToBottomEle = document.getElementById('scroll-to-bottom');
    const floatingNav = document.getElementById('floating-nav');
    const toggleNav = document.getElementById('toggle-nav');
    const menuNavIcon = toggleNav?.querySelector('.menu-nav-icon');
    const closeNavIcon = toggleNav?.querySelector('.close-nav-icon');

    // 圣诞开关按钮
    const toggleChristmasBtn = document.getElementById('toggle-christmas');

    let isExpanded = true; // 默认展开

    const syncToggleState = () => {
      if (!floatingNav) return;
      floatingNav.setAttribute('data-expanded', String(isExpanded));
      toggleNav?.setAttribute('aria-expanded', String(isExpanded));
      menuNavIcon?.classList.toggle('hidden', isExpanded);
      closeNavIcon?.classList.toggle('hidden', !isExpanded);
    };

    // 初始化圣诞状态（图标显示由 CSS 根据 html.christmas 类控制）
    initChristmasState();

    // 圣诞开关点击事件
    // 浮动按钮使用"彻底关闭"模式：关闭时同时隐藏装饰球
    const handleToggleChristmas = () => {
      if (christmasEnabled.get()) {
        disableChristmasCompletely();
      } else {
        enableChristmas();
      }
    };

    toggleChristmasBtn?.addEventListener('click', handleToggleChristmas);

    // 展开/收起功能
    const handleToggleNav = () => {
      isExpanded = !isExpanded;
      syncToggleState();
    };

    syncToggleState();

    toggleNav?.addEventListener('click', handleToggleNav);

    // Subscribe to drawer state - hide FloatingGroup when drawer is open
    const unsubscribe = drawerOpen.subscribe((isDrawerOpen) => {
      if (!floatingNav) return;
      // Hide floating nav when mobile drawer is open to prevent UI conflicts
      if (isDrawerOpen) {
        floatingNav.style.transform = 'translateX(200%)';
        floatingNav.style.opacity = '0';
        floatingNav.style.pointerEvents = 'none';
      } else {
        floatingNav.style.transform = '';
        floatingNav.style.opacity = '';
        floatingNav.style.pointerEvents = '';
      }
    });

    // 回到顶部
    const scrollToTop = () => {
      window.scrollTo({
        top: 0,
        behavior: 'smooth',
      });
    };

    scrollToTopEle?.addEventListener('click', scrollToTop);

    // 滚动到底部
    const scrollToBottom = () => {
      window.scrollTo({
        top: document.documentElement.scrollHeight,
        behavior: 'smooth',
      });
    };

    scrollToBottomEle?.addEventListener('click', scrollToBottom);

    // 清理函数
    return () => {
      scrollToTopEle?.removeEventListener('click', scrollToTop);
      scrollToBottomEle?.removeEventListener('click', scrollToBottom);
      toggleNav?.removeEventListener('click', handleToggleNav);
      toggleChristmasBtn?.removeEventListener('click', handleToggleChristmas);
      unsubscribe(); // Unsubscribe from drawer state
    };
  }

  // 清理函数引用
  let cleanup: (() => void) | null = null;

  function init() {
    if (cleanup) cleanup();
    cleanup = initFloatingNav();
  }

  // 初始化：检查 DOM 是否已加载
  if (document.readyState !== 'loading') {
    init();
  }

  // 在每次页面加载时重新初始化（Astro 页面导航）
  document.addEventListener('astro:page-load', init);

  // 在页面切换前清理（防止内存泄漏）
  document.addEventListener('astro:before-swap', () => {
    if (cleanup) {
      cleanup();
      cleanup = null;
    }
  });
</script>

<style>
  #floating-nav {
    transition: transform 0.3s ease-in-out;
    /* transform: translateY(200%); */
  }

  #nav-content {
    transform-origin: bottom;
    transition: all 0.15s ease-in-out;
  }

  #floating-nav[data-expanded='false'] #nav-content {
    transform: translateY(150%);
    opacity: 0;
    pointer-events: none;
  }

  #floating-nav[data-expanded='true'] #nav-content {
    transform: translateY(0);
    opacity: 1;
  }

  button {
    opacity: 0.8;
    transition: opacity 0.2s ease-in-out;
  }

  button:hover {
    opacity: 1;
  }

  /* 根据 html.christmas 类控制图标显示，避免 FOUC */
  :global(html.christmas) .christmas-on-icon {
    display: block;
  }
  :global(html.christmas) .christmas-off-icon {
    display: none;
  }
  :global(html:not(.christmas)) .christmas-on-icon {
    display: none;
  }
  :global(html:not(.christmas)) .christmas-off-icon {
    display: block;
  }
</style>
