---
import ButtonLink from '@components/control/ButtonLink.astro';
import ThemeToggle from '@components/theme/ThemeToggle.astro';
import { routers } from '@constants/router';
import { cn } from '@lib/utils';
import { Icon } from 'astro-icon/components';
import DropdownNav from './DropdownNav';
import SearchWithDialog from './SearchWithDialog.astro';
---

<div class="tablet:grow-0 flex grow items-center">
  <!-- 导航菜单 -->
  <div class="tablet:hidden flex grow items-center">
    {
      routers.map((item) => {
        if (item.children?.length) {
          return <DropdownNav client:load item={item} />;
        }
        return (
          <ButtonLink
            url={item.path}
            label={item.name}
            variant="unstyle"
            className={cn(
              'relative text-base tracking-wider after:absolute after:bottom-1 after:left-1/2 after:block after:h-0.5 after:w-0 after:-translate-x-1/2 after:transition-all after:duration-300',
              {
                'hover:after:w-9/12': true,
                'after:w-9/12': item.path === Astro.url.pathname,
              },
            )}
          >
            {item.icon && <Icon name={item.icon} class="mr-1.5" />}
            {item.name}
          </ButtonLink>
        );
      })
    }
  </div>

  <div class="ml-auto flex items-center gap-2">
    <SearchWithDialog />
    <ThemeToggle />
  </div>
</div>

<script is:inline>
  let firstScroll = true;
  let triggerDistance = window.innerHeight * 0.45;
  let lastScrollY = 0;
  let scrollEndTimer = null;
  let isScrolling = false;
  let scrollHandler = null;
  const SCROLL_END_DELAY = 800; // 滚动停止后延迟恢复自动隐藏的时间

  // 检查是否在文章页面且是移动端
  const isPostPageMobile = () => {
    const isMobile = window.innerWidth <= 992;
    const isPostPage = window.location.pathname.startsWith('/post/');
    return isMobile && isPostPage;
  };

  const handleScroll = () => {
    const siteHeader = document.getElementById('site-header');
    const mobileMenuContainer = document.getElementById('mobile-menu-container');
    const currentScrollY = window.scrollY;
    const isBeyond = currentScrollY > triggerDistance;

    if (siteHeader) {
      if (isBeyond) {
        siteHeader.classList.add('with-background');
      } else {
        siteHeader.classList.remove('with-background');
      }
    }

    if (firstScroll) {
      firstScroll = false;
      return;
    }

    // 文章页面移动端：滚动时保持 header 显示
    if (isPostPageMobile()) {
      // 清除之前的定时器
      if (scrollEndTimer) {
        clearTimeout(scrollEndTimer);
      }
      isScrolling = true;

      // 滚动时确保 header 显示
      if (siteHeader) siteHeader.classList.remove('-translate-y-full');
      if (mobileMenuContainer) mobileMenuContainer.classList.remove('-translate-y-full');

      // 滚动停止后一段时间才恢复自动隐藏行为
      scrollEndTimer = setTimeout(() => {
        isScrolling = false;
      }, SCROLL_END_DELAY);

      lastScrollY = currentScrollY;
      return;
    }

    // 非文章页面或桌面端：正常的隐藏/显示逻辑
    if (currentScrollY > 0) {
      if (currentScrollY > lastScrollY) {
        // 向下滚动
        if (siteHeader) siteHeader.classList.add('-translate-y-full');
        if (mobileMenuContainer) mobileMenuContainer.classList.add('-translate-y-full');
      } else {
        // 向上滚动
        if (siteHeader) siteHeader.classList.remove('-translate-y-full');
        if (mobileMenuContainer) mobileMenuContainer.classList.remove('-translate-y-full');
      }
    }
    lastScrollY = currentScrollY;
  };

  // 节流函数
  function throttle(func, limit) {
    let lastFunc;
    let lastRan;
    return function () {
      const context = this;
      const args = arguments;
      if (!lastRan) {
        func.apply(context, args);
        lastRan = Date.now();
      } else {
        clearTimeout(lastFunc);
        lastFunc = setTimeout(
          function () {
            if (Date.now() - lastRan >= limit) {
              func.apply(context, args);
              lastRan = Date.now();
            }
          },
          limit - (Date.now() - lastRan),
        );
      }
    };
  }

  function initNavigator() {
    // 清理旧的监听器
    if (scrollHandler) {
      window.removeEventListener('scroll', scrollHandler);
    }
    if (scrollEndTimer) {
      clearTimeout(scrollEndTimer);
      scrollEndTimer = null;
    }

    // 重置状态
    firstScroll = true;
    triggerDistance = window.innerHeight * 0.45;
    lastScrollY = window.scrollY;
    isScrolling = false;

    // 检查初始滚动位置，设置背景状态
    const siteHeader = document.getElementById('site-header');
    if (siteHeader) {
      if (window.scrollY > triggerDistance) {
        siteHeader.classList.add('with-background');
      } else {
        siteHeader.classList.remove('with-background');
      }
    }

    // 添加新监听器
    scrollHandler = throttle(handleScroll, 80);
    window.addEventListener('scroll', scrollHandler, { passive: true });
  }

  // 首次加载时立即初始化
  if (document.readyState !== 'loading') {
    initNavigator();
  }

  // 监听后续页面导航
  document.addEventListener('astro:page-load', initNavigator);

  // 页面切换前清理
  document.addEventListener('astro:before-swap', () => {
    if (scrollHandler) {
      window.removeEventListener('scroll', scrollHandler);
      scrollHandler = null;
    }
    if (scrollEndTimer) {
      clearTimeout(scrollEndTimer);
      scrollEndTimer = null;
    }
  });
</script>
